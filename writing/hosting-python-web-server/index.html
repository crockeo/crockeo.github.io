<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Home of the Crockeo</title>
    <link rel="stylesheet" href="/base.css" />
    
<link rel="stylesheet" href="/writing_page.css" />

  </head>

  <body
    class="
    bg-lime-100
    text-green-900
    flex
    flex-col
    h-screen
    m-0
    select-none
    "
  >
    <div
      class="
      flex
      flex-none
      flex-row
      font-semibold
      justify-center
      p-4
      space-x-8
      text-xl
      "
    >
      <a class="group" href="/">üè° <span class="group-hover:underline">Home</span></a>
      <span class="font-light">|</span>
      <a class="group" href="/writing">üìù <span class="group-hover:underline">Writing</span></a>
      <span class="font-light">|</span>
      <a class="group" href="/work">üíΩ <span class="group-hover:underline">Work</span></a>
    </div>

    

<div
  class="
  grow
  mt-8
  mx-auto
  pb-16
  "
>
  <div class="flex flex-row items-end justify-between">
    <div class="font-bold text-4xl">Hosting a Python Server</div>
    <div class="italic">2024-10-21</div>
  </div>
  <div class="italic">A recipe for running a Python-based web server available to the public internet.</div>

  <hr class="max-w-xl my-2 border-green-900" />

  <div class="content max-w-xl">
    <h1 id="python-app">Python App</h1>
<ul>
<li>I've been using <a href="https://fastapi.tiangolo.com/">FastAPI</a> and <a href="https://www.uvicorn.org/">Uvicorn</a> for my apps.
You can refer to their documentation for setting up a web server.</li>
<li>I've also been taken to using <a href="https://htmx.org/">htmx</a> and <a href="https://jinja.palletsprojects.com/en/3.1.x/">Jinja</a> for simple websites, rather than using a frontend framework like React (or similar), for the sake of simplicity.</li>
<li>I would also recommend setting up your project to work with <a href="https://github.com/astral-sh/uv">uv</a>, because it will make deploying your code much, much easier.</li>
<li>Important for your deployed environment: you don't want <code>uvicorn</code> listening to a public port, instead you want to proxy traffic through <code>nginx</code>.</li>
<li>I have the following code set up, so I can choose the right <code>uvicorn</code> configuration for the context.
<ul>
<li>In local dev (when <code>PROFILE</code> is not set) it listens on TCP at <code>127.0.0.1:8080</code>.</li>
<li>In prod it instead listens to a Unix domain socket at <code>/tmp/uvicorn.sock</code>.
<ul>
<li>Keep this in mind! When we get to Nginx configuration this is going to come back!</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>os
</span><span>
</span><span style="color:#b48ead;">import </span><span>uvicorn
</span><span>
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">main</span><span>() -&gt; </span><span style="color:#d08770;">None</span><span>:
</span><span>    profile = os.environ.</span><span style="color:#bf616a;">get</span><span>(&quot;</span><span style="color:#a3be8c;">PROFILE</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">dev</span><span>&quot;)
</span><span>    match profile:
</span><span>        case &quot;</span><span style="color:#a3be8c;">dev</span><span>&quot;:
</span><span>            </span><span style="color:#65737e;"># Used in local dev, so you can connect through your browser.
</span><span>            uvicorn.</span><span style="color:#bf616a;">run</span><span>(
</span><span>                &quot;</span><span style="color:#a3be8c;">yarn_finder.wsgi:app</span><span>&quot;,
</span><span>                </span><span style="color:#bf616a;">host</span><span>=&quot;</span><span style="color:#a3be8c;">127.0.0.1</span><span>&quot;,
</span><span>                </span><span style="color:#bf616a;">port</span><span>=</span><span style="color:#d08770;">8080</span><span>,
</span><span>                </span><span style="color:#bf616a;">reload</span><span>=</span><span style="color:#d08770;">True</span><span>,
</span><span>            )
</span><span>
</span><span>        case &quot;</span><span style="color:#a3be8c;">prod</span><span>&quot;:
</span><span>            </span><span style="color:#65737e;"># Used in prod, for Nginx.
</span><span>            uvicorn.</span><span style="color:#bf616a;">run</span><span>(
</span><span>                &quot;</span><span style="color:#a3be8c;">yarn_finder.wsgi:app</span><span>&quot;,
</span><span>                </span><span style="color:#bf616a;">uds</span><span>=&quot;</span><span style="color:#a3be8c;">/tmp/uvicorn.sock</span><span>&quot;,
</span><span>            )
</span><span>
</span><span>
</span><span style="color:#b48ead;">if </span><span>__name__ == &quot;</span><span style="color:#a3be8c;">__main__</span><span>&quot;:
</span><span>    </span><span style="color:#bf616a;">main</span><span>()
</span></code></pre>
<p>You can find an up-to-date version <a href="https://github.com/crockeo/yarn-finder/blob/main/yarn_finder/main.py">in the GitHub repo for this project</a>.</p>
<h1 id="getting-a-server">Getting a Server</h1>
<ul>
<li>You can easily provisiong compute from <a href="https://aws.amazon.com/free/compute/lightsail/">Amazon Lightsail</a>.
Other compute will work as well, so feel free to choose your own compute here!</li>
<li>If using Lightsail you will only have <code>:80</code> exposed by default.
You will need to expose <code>:443</code> as well for when you set up HTTPS:
<ul>
<li>Go to Amazon Lightsail.</li>
<li>Click on your instance.</li>
<li>Click on <code>Networking</code>.</li>
<li>Scroll to <code>IPv4 Firewall</code> and add click <code>+ Add rule</code>.</li>
<li>Choose <code>HTTPS</code> for the <code>Application</code>, and then click <code>Create</code>.</li>
</ul>
</li>
<li>Set up SSH:
<ul>
<li>Will have more information on this, Soon‚Ñ¢, but this is well documented on the internet.</li>
<li>You can go and find how to connect to your Lightsail instance over SSH, or you can use the web browser.</li>
</ul>
</li>
</ul>
<h1 id="nginx">Nginx</h1>
<ul>
<li>I was using Ubuntu for this project, so going to talk about configuring this for Ubuntu. Your mileage may vary when using other operating systems.</li>
<li>Install Nginx: <code>sudo apt-get update &amp;&amp; sudo apt-get install nginx</code>. This will start <code>nginx</code> by default so you can go to <code>http://&lt;your IP&gt;</code> and see the default <code>nginx</code> screen.</li>
<li>And then you can set a sane default configuration for your app by replacing the content in <code>/etc/nginx/sites-enabled/default</code>:</li>
</ul>
<pre data-lang="nginx.conf" style="background-color:#2b303b;color:#c0c5ce;" class="language-nginx.conf "><code class="language-nginx.conf" data-lang="nginx.conf"><span>server {
</span><span>	client_max_body_size 4G;
</span><span>
</span><span>	server_name &lt;your URL&gt;;
</span><span>
</span><span>	location / {
</span><span>		proxy_set_header Host $http_host;
</span><span>		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span>		proxy_set_header X-Forwarded-Proto $scheme;
</span><span>		proxy_set_header Upgrade $http_upgrade;
</span><span>		proxy_set_header Connection $connection_upgrade;
</span><span>		proxy_redirect off;
</span><span>		proxy_buffering off;
</span><span>		proxy_pass http://uvicorn;
</span><span>	}
</span><span>}
</span><span>
</span><span>map $http_upgrade $connection_upgrade {
</span><span>	default upgrade;
</span><span>	&#39;&#39; close;
</span><span>}
</span><span>
</span><span># Note: this is where the uvicorn.sock thing comes back!
</span><span>upstream uvicorn {
</span><span>	server unix:/tmp/uvicorn.sock;
</span><span>}
</span></code></pre>
<ul>
<li>And then you need to restart nginx: <code>sudo systemctl reload nginx</code>.</li>
<li>You can go to the IP address of the box you've provisioned
and you should a "502 Bad Gateway" page.</li>
</ul>
<h1 id="dns-configuration">DNS Configuration</h1>
<ul>
<li>The specific actions you have to take are going to vary a lot by your specific DNS provider. I'll talk about Squarespace, but first talk about the task in generic terms.</li>
<li>I'm assuming you're hosting on a subdomain, but most of these steps will be similar no matter what.</li>
<li>DNS configuration:
<ul>
<li>You're going to want to add an <code>A</code> record where your <code>Host</code> is your subdomain name (e.g. <code>yarnfinder</code>) pointing to your IPv4 IP address (in the form <code>A.B.C.D</code>).</li>
<li>And then do the same for an <code>AAAA</code> record pointing to your IPv6 address (the long one with tons of <code>:</code>s).</li>
</ul>
</li>
<li>On Squarespace, you do this under the <code>Custom records</code> section. Click <code>Add Record</code> and then you can do the rest of what I've said here.
<ul>
<li>Note that if you're hosting this on a top-level domain managed by Squarespace, you should set the <code>Host</code> to <code>@</code>.</li>
</ul>
</li>
</ul>
<h1 id="https-configuration">HTTPS Configuration</h1>
<ul>
<li>TL;DR: <a href="https://certbot.eff.org/instructions">certbot</a></li>
<li>I followed the <a href="https://certbot.eff.org/instructions?ws=nginx&amp;os=snap">Nginx + Linux (snap)</a> instructions piece by piece and it all worked for me. You should be able to do the same--it's super easy to set up.</li>
<li>If you get an error saying that it can't install because of a server name,
you've probably forgotten to replace <code>&lt;your URL&gt;</code>.
Try replacing it with your domain name :)</li>
<li>And finally: <code>sudo systemctl reload nginx</code>.</li>
</ul>
<h1 id="running-your-code">Running Your Code</h1>
<ul>
<li>At this point if you go to your website you're going to get a very nice HTTPS-backed HTTP 503 error, because your server isn't running.</li>
<li>There are a couple of things we have to do to get your code running:
<ul>
<li>Get a copy of your code to the machine.</li>
<li>Set up <a href="https://github.com/astral-sh/uv">uv</a> on the remote machine.</li>
<li>Get your server running.</li>
</ul>
</li>
</ul>
<h2 id="getting-code-to-the-cloud">Getting code to the cloud</h2>
<ul>
<li>My project <a href="https://github.com/crockeo/yarn-finder">happens to be open source</a> so this is easy: I just <code>git clone &lt;url&gt;</code> to get it onto the machine.</li>
<li>If you want your project to be closed source, you could set it up in a couple of ways:
<ul>
<li><a href="https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent">Make an SSH key on your Lightsail instance</a>, and use that to clone from a private repository.</li>
<li>Or if you set up SSH between your local machine and the Lightsail instance, you could use <a href="https://linux.die.net/man/1/scp">scp</a>.</li>
<li>I'm going to leave definitive guidance up to the reader.</li>
</ul>
</li>
</ul>
<h2 id="setting-up-uv">Setting up <code>uv</code></h2>
<ul>
<li><a href="https://github.com/astral-sh/uv?tab=readme-ov-file#installation">This is so simple</a>.</li>
<li>TL;DR: <code>curl -LsSf https://astral.sh/uv/install.sh | sh</code>
<ul>
<li>You should probably download it and inspect it first as well :)</li>
</ul>
</li>
</ul>
<h2 id="get-your-server-running">Get your server running</h2>
<ul>
<li>I'm assuming you're in your working directory, and your <code>main.py</code> file (the thing pasted in this blog post) is in <code>&lt;your_project&gt;/main.py</code>.</li>
<li>There are multiple ways to run your server, some are better and some are easier. I'm going to go for the easiest option: <code>screen</code>.
<ul>
<li>If you want to know how to do this better, you can read <a href="https://medium.com/@benmorel/creating-a-linux-service-with-systemd-611b5c8b91d6">other posts on the internet</a>!</li>
</ul>
</li>
<li>Just run it with 2 commands:
<ul>
<li><code>PROFILE=prod screen uv run python -m &lt;your_project&gt;/main.py</code> (to run your server under <code>screen</code>).</li>
<li><code>Ctrl+A</code> -&gt; <code>D</code> (to detach you from the <code>screen</code> session).</li>
</ul>
</li>
</ul>

  </div>
</div>


  </body>
</html>
